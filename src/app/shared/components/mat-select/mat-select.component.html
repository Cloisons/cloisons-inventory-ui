<mat-form-field 
  [appearance]="finalConfig.appearance || 'outline'" 
  [class]="'mat-select-field ' + (finalConfig.size || 'medium') + '-size'"
  [class.has-error]="finalConfig.errorMessage || errorMessage"
  [class.disabled]="finalConfig.disabled"
>
  <mat-label *ngIf="finalConfig.showLabel && finalConfig.label">
    {{ finalConfig.label }}
    <span class="required-indicator" *ngIf="finalConfig.required">*</span>
  </mat-label>

  <mat-select
    [placeholder]="finalConfig.placeholder || 'Select an option'"
    [disabled]="finalConfig.disabled"
    [multiple]="finalConfig.multiple"
    [value]="value"
    [compareWith]="compareWithFunction"
    [panelClass]="finalConfig.panelClass || ''"
    (selectionChange)="onSelectionChange($event.value)"
    (openedChange)="onOpenedChange($event)"
    (blur)="onBlur()"
    class="mat-select-element"
  >
    <!-- Search input for searchable selects -->
    <mat-option *ngIf="finalConfig.searchable" disabled class="search-option">
      <input
        matInput
        [value]="searchControl.value"
        (input)="onSearchInput($event)"
        placeholder="Search options..."
        class="search-input"
        (click)="$event.stopPropagation()"
      />
    </mat-option>

    <!-- Clear option for single select -->
    <mat-option 
      *ngIf="finalConfig.clearable && !finalConfig.multiple && hasValue" 
      [value]="null"
      class="clear-option"
    >
      <mat-icon>clear</mat-icon>
      Clear Selection
    </mat-option>

    <!-- Options list -->
    <mat-option
      *ngFor="let option of currentOptions"
      [value]="option.value"
      [disabled]="option.disabled"
      class="select-option"
    >
      <div class="option-content">
        <mat-icon *ngIf="option.icon" class="option-icon">{{ option.icon }}</mat-icon>
        <div class="option-text">
          <span class="option-label">{{ option.label }}</span>
          <span *ngIf="option.description" class="option-description">{{ option.description }}</span>
        </div>
      </div>
    </mat-option>

    <!-- No options message -->
    <mat-option *ngIf="currentOptions.length === 0" disabled class="no-options">
      No options available
    </mat-option>
  </mat-select>

  <!-- Selected values display for multiple select -->
  <div *ngIf="finalConfig.multiple && hasValue" class="selected-chips">
    <mat-chip-listbox>
      <mat-chip-option
        *ngFor="let selectedValue of value"
        [removable]="true"
        (removed)="removeChip(selectedValue)"
        class="selected-chip"
      >
        {{ getOptionLabel(selectedValue) }}
        <button matChipRemove>
          <mat-icon>cancel</mat-icon>
        </button>
      </mat-chip-option>
    </mat-chip-listbox>
  </div>

  <!-- Clear button for single select -->
  <button
    *ngIf="finalConfig.clearable && !finalConfig.multiple && hasValue && !finalConfig.disabled"
    matSuffix
    mat-icon-button
    (click)="clearSelection()"
    class="clear-button"
    type="button"
    [attr.aria-label]="'Clear selection'"
  >
    <mat-icon>clear</mat-icon>
  </button>

  <!-- Hint text -->
  <mat-hint *ngIf="finalConfig.hint && !finalConfig.errorMessage">
    {{ finalConfig.hint }}
  </mat-hint>

  <!-- Error message -->
  <mat-error *ngIf="finalConfig.errorMessage || errorMessage" role="alert">
    {{ finalConfig.errorMessage || errorMessage }}
  </mat-error>
</mat-form-field>


