<div class="content-wrapper">
  <header class="page-header flex-wrap pb-0">
    <div class="page-title">
      <h3 class="mb-0">Edit Project</h3>
      <span class="pl-0 h6 text-sub d-inline-block">Update project details</span>
    </div>
    <nav class="breadcrumb-nav" aria-label="Breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a routerLink="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item"><a routerLink="/projects">Projects</a></li>
        <li class="breadcrumb-item active" aria-current="page">Edit</li>
      </ol>
    </nav>
  </header>

  <main class="row">
    <div class="col-xl-12 grid-margin stretch-card">
      <section class="card">
        <div class="card-body">

          <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>

            <div class="row">
              <div class="col-xl-5 col-lg-6 col-md-8 left-forms-block left-forms-project-block">

                <div class="form-group">
                  <app-mat-input label="Project Name" id="projectName" class="" type="text"
                    formControlName="projectName">
                  </app-mat-input>
                </div>

                <div class="form-group">
                  <label for="projectDescription">Description</label>
                  <textarea id="projectDescription" class="form-control" placeholder="Enter project description..."
                    formControlName="projectDescription" rows="3"></textarea>
                </div>

                <div class="form-group">
                  <label for="contractorId">Contractor</label>
                  <ng-select id="contractorId" formControlName="contractorId" [items]="contractorOptions"
                    bindLabel="label" bindValue="value" placeholder="Select contractor" [searchable]="true"
                    [clearable]="true" [loading]="contractorOptions.length === 0" class="">
                  </ng-select>
                </div>

                <div class="form-group">
                  <label for="status">Status <span class="text-danger">*</span></label>
                  <ng-select
                    id="status"
                    formControlName="status"
                    [items]="availableStatuses"
                    bindLabel="label"
                    bindValue="value"
                    placeholder="Select status"
                    [clearable]="false"
                    [searchable]="true"
                    (change)="onStatusChange()">
                  </ng-select>
                  <div *ngIf="!canChangeStatusToPlanning" class="form-text text-warning">
                    <i class="mdi mdi-information"></i>
                    Once a project moves away from Planning status, it cannot be changed back to Planning.
                  </div>
                </div>

                <div class="form-group">
                  <app-mat-input label="Start Date" id="startDate" type="date" class="" formControlName="startDate">
                  </app-mat-input>
                </div>

                <!-- Products Section -->
                <div class="form-group mb-4 file-upload-block">
                  <label class="mb-2">Products <span class="text-muted">(optional)</span></label>

                  <!-- Restriction Message -->
                  <div *ngIf="!canEditProducts" class="alert alert-warning" role="alert">
                    <i class="mdi mdi-lock"></i>
                    <strong>Products cannot be modified:</strong> Products can only be added or updated when the project
                    status is "Planning".
                  </div>

                  <!-- Products Table -->
                  <div formArrayName="products" class="table-responsive add-product-item-add mt-2"
                    [class.disabled-section]="!canEditProducts">
                    <table class="table table-bordered table-hover">
                      <thead class="table-light">
                        <tr>
                          <th width="50%">Product <span class="text-danger">*</span></th>
                          <th width="25%"></th>
                          <th width="15%">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let product of products.controls; let i = index" [formGroupName]="i">
                          <td>
                            <ng-multiselect-dropdown *ngIf="productDropdownSettings && canEditProducts"
                              [placeholder]="'Select a product'" [settings]="productDropdownSettings"
                              [data]="getAvailableProductsForIndex(i)" formControlName="selectedProduct"
                              (onSelect)="onProductSelect($event, i)" (onDeSelect)="onProductDeSelect($event, i)"
                              class="form-control"
                              [ngClass]="{'is-invalid': product.get('productId')?.invalid && product.get('productId')?.touched}">
                            </ng-multiselect-dropdown>
                            <div *ngIf="!canEditProducts && product.get('productId')?.value"
                              class="form-control-plaintext">
                              {{ getProductName(product.get('productId')?.value) }}
                            </div>
                            <div *ngIf="product.get('productId')?.invalid && product.get('productId')?.touched"
                              class="invalid-feedback d-block">
                              <div *ngIf="product.get('productId')?.errors?.['required']">Please select a product</div>
                              <div *ngIf="product.get('productId')?.errors?.['duplicate']">This product is already
                                selected</div>
                            </div>
                          </td>
                          <td>
                            <app-mat-input label="Quantity" *ngIf="canEditProducts" type="number"
                              formControlName="quantity" class="form-control" min="1"
                              [class.is-invalid]="product.get('quantity')?.invalid && product.get('quantity')?.touched">
                            </app-mat-input>
                            <div *ngIf="!canEditProducts" class="form-control-plaintext">
                              {{ product.get('quantity')?.value }}
                            </div>
                            <div *ngIf="product.get('quantity')?.invalid && product.get('quantity')?.touched"
                              class="invalid-feedback d-block">
                              <div *ngIf="product.get('quantity')?.errors?.['required']">Required</div>
                              <div *ngIf="product.get('quantity')?.errors?.['min']">Min: 1</div>
                            </div>
                          </td>
                          <td class="text-left product-delete">
                            <button *ngIf="canEditProducts" type="button" class="btn btn-outline-danger btn-sm"
                              (click)="removeProduct(i)" title="Remove product">
                              <i class="mdi mdi-delete"></i>
                            </button>
                            <span *ngIf="!canEditProducts" class="text-muted">
                              <i class="mdi mdi-lock"></i>
                            </span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <!-- Add Product Button -->
                  <div class="mt-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" (click)="addProduct()"
                      [disabled]="!canEditProducts">
                      <i class="mdi mdi-plus"></i> Add Product
                    </button>
                  </div>

                  <!-- Loading State -->
                  <div *ngIf="loadingProducts" class="alert alert-info" role="status">
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Loading products...
                  </div>
                </div>

                <!-- Direct Items Section -->
                <div class="form-group mb-4 file-upload-block">
                  <label class="mb-2 d-flex align-items-center justify-content-between">
                    <span>Direct Items <span class="text-muted">(optional)</span></span>
                    <button type="button" class=" btn-link p-0" (click)="onOpenCreateItemModal()"
                      [disabled]="!canEditDirectItems">+ Create new item</button>
                  </label>

                  <!-- Direct Items Table -->
                  <div formArrayName="directItems" class="table-responsive add-product-item-add mt-2">
                    <table class="table table-bordered table-hover">
                      <thead class="table-light">
                        <tr>
                          <th width="50%">Item</th>
                          <th width="25%"></th>
                          <th width="15%">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let item of directItems.controls; let i = index" [formGroupName]="i">
                          <td>
                            <ng-multiselect-dropdown *ngIf="itemDropdownSettings && canEditDirectItems"
                              [placeholder]="'Select an item'" [settings]="itemDropdownSettings"
                              [data]="getAvailableDirectItemsForIndex(i)" formControlName="selectedItem"
                              (onSelect)="onDirectItemSelect($event, i)" (onDeSelect)="onDirectItemDeSelect($event, i)"
                              class="form-control"
                              [ngClass]="{'is-invalid': item.get('itemId')?.invalid && item.get('itemId')?.touched}">
                            </ng-multiselect-dropdown>
                            <div *ngIf="!canEditDirectItems && item.get('itemId')?.value"
                              class="form-control-plaintext">
                              {{ getItemName(item.get('itemId')?.value) }}
                            </div>
                            <div *ngIf="item.get('itemId')?.invalid && item.get('itemId')?.touched"
                              class="invalid-feedback d-block">
                              <div *ngIf="item.get('itemId')?.errors?.['duplicate']">This item is already selected</div>
                            </div>
                          </td>
                          <td>
                            <app-mat-input label="Quantity" *ngIf="canEditDirectItems" type="number"
                              formControlName="quantity" class="form-control" min="1"
                              [class.is-invalid]="item.get('quantity')?.invalid && item.get('quantity')?.touched">
                            </app-mat-input>
                            <div *ngIf="!canEditDirectItems" class="form-control-plaintext">
                              {{ item.get('quantity')?.value }}
                            </div>
                            <div *ngIf="item.get('quantity')?.invalid && item.get('quantity')?.touched"
                              class="invalid-feedback d-block">
                              <div *ngIf="item.get('quantity')?.errors?.['required']">Required</div>
                              <div *ngIf="item.get('quantity')?.errors?.['min']">Min: 1</div>
                            </div>
                          </td>
                          <td class="text-left product-delete">
                            <button *ngIf="canEditDirectItems" type="button" class="btn btn-outline-danger btn-sm"
                              (click)="removeDirectItem(i)" title="Remove direct item">
                              <i class="mdi mdi-delete"></i>
                            </button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <!-- Add Direct Item Button -->
                  <div class="mt-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" (click)="addDirectItem()"
                      [disabled]="!canEditDirectItems">
                      <i class="mdi mdi-plus"></i> Add Direct Item
                    </button>
                  </div>

                  <!-- Loading State -->
                  <div *ngIf="loadingItems" class="alert alert-info" role="status">
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Loading items...
                  </div>
                </div>

                <app-create-item-modal [isVisible]="showCreateItemModal" (closed)="onCloseCreateItemModal()"
                  (created)="onItemCreatedFromModal($event)">
                </app-create-item-modal>

              </div>
            </div>



            <div class="d-flex justify-content-end">
              <a routerLink="/projects" class="btn btn-primary secondary-line-btn-cancel">Cancel</a>
              <button type="submit" class="btn btn-primary ms-2" [disabled]="submitting || form.invalid">Save</button>
            </div>
          </form>


        </div>
      </section>
    </div>
  </main>
</div>