<div class="content-wrapper">
  <header class="page-header flex-wrap pb-0">
    <div class="page-title">
      <h3 class="mb-0">Add Project</h3>
     <span class="pl-0 h6 text-sub d-inline-block">Create a new project</span>
    </div>
    <nav class="breadcrumb-nav" aria-label="Breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a routerLink="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item"><a routerLink="/projects">Projects</a></li>
        <li class="breadcrumb-item active" aria-current="page">Add</li>
      </ol>
    </nav>
  </header>

  <main class="row">
    <div class="col-xl-12 grid-margin stretch-card">
      <section class="card">
        <div class="card-body">

      
  <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>
    <div class="row">
            <div class="col-xl-5 col-lg-6 col-md-8 left-forms-block left-forms-project-block">
            <div class="form-group">
              <app-mat-input label="Project Name" id="projectName" class="" type="text" formControlName="projectName" [required]="true"
                [formControl]="projectNameControl">
              </app-mat-input>
            </div>

            <div class="form-group">
              <label for="projectDescription">Description</label>
              <textarea id="projectDescription" class="form-control" placeholder="Enter project description..."
                formControlName="projectDescription" rows="3"
                [class.is-invalid]="projectDescriptionControl.invalid && projectDescriptionControl.touched"></textarea>
              <div class="invalid-feedback" *ngIf="projectDescriptionControl.invalid && projectDescriptionControl.touched">
                <span *ngIf="projectDescriptionControl.errors?.['maxlength']">
                  Description cannot exceed {{ projectDescriptionControl.errors?.['maxlength'].requiredLength }} characters
                </span>
              </div>
            </div>

            <div class="form-group">
              <label for="contractorId">Contractor <span class="text-danger">*</span></label>
              <ng-select
                id="contractorId"
                formControlName="contractorId"
                [items]="contractorOptions"
                bindLabel="label"
                bindValue="value"
                placeholder="Select contractor"
                [searchable]="true"
                [clearable]="true"
                [loading]="contractorOptions.length === 0"
                [class.is-invalid]="contractorIdControl.invalid && contractorIdControl.touched"
                class="">
              </ng-select>
              <div class="invalid-feedback" *ngIf="contractorIdControl.invalid && contractorIdControl.touched">
                <span *ngIf="contractorIdControl.errors?.['required']">Contractor is required</span>
              </div>
            </div>

            <div class="form-group">
              <label for="status">Status <span class="text-danger">*</span></label>
              <ng-select
                id="status"
                formControlName="status"
                [items]="statuses"
                bindLabel="label"
                bindValue="value"
                placeholder="Select status"
                [clearable]="false"
                [searchable]="true"
                [class.is-invalid]="statusControl.invalid && statusControl.touched">
              </ng-select>
              <div class="invalid-feedback" *ngIf="statusControl.invalid && statusControl.touched">
                <span *ngIf="statusControl.errors?.['required']">Status is required</span>
              </div>
            </div>

            <div class="form-group">
              <app-mat-input label="Start Date" id="startDate" type="date" class="" formControlName="startDate"
                [formControl]="startDateControl">
              </app-mat-input>
            </div>

            <!-- Products Section -->
            <div class="form-group mb-4 file-upload-block">
              <label class="mb-2">Products (optional) </label>
              
              <!-- Products Table -->
              <div formArrayName="products" class="table-responsive add-product-item-add mt-2">
                <table class="table table-bordered table-hover">
                  <thead class="table-light">
                    <tr>
                      <th width="50%">Product</th>
                      <th width="25%"></th>
                      <th width="15%">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr 
                      *ngFor="let product of products.controls; let i = index" 
                      [formGroupName]="i"
                    >
                      <td>
                        <ng-multiselect-dropdown
                          *ngIf="productDropdownSettings"
                          [placeholder]="'Select a product'"
                          [settings]="productDropdownSettings"
                          [data]="getAvailableProductsForIndex(i)"
                          formControlName="selectedProduct"
                          (onSelect)="onProductSelect($event, i)"
                          (onDeSelect)="onProductDeSelect($event, i)"
                          class="form-control"
                          [ngClass]="{'is-invalid': product.get('productId')?.errors?.['duplicate'] && product.get('productId')?.touched}"
                        >
                        </ng-multiselect-dropdown>
                        <div 
                          *ngIf="product.get('productId')?.errors?.['duplicate'] && product.get('productId')?.touched" 
                          class="invalid-feedback d-block"
                        >
                          <div>This product is already selected</div>
                        </div>
                      </td>
                      <td>
                        <app-mat-input label="Quantity" 
                          type="number" 
                          formControlName="quantity" 
                          class="form-control"
                          min="1"
                          [class.is-invalid]="product.get('quantity')?.invalid && product.get('quantity')?.touched">
                        </app-mat-input>
                        <div 
                          *ngIf="product.get('quantity')?.invalid && product.get('quantity')?.touched" 
                          class="invalid-feedback d-block"
                        >
                          <div *ngIf="product.get('quantity')?.errors?.['required']">Required</div>
                          <div *ngIf="product.get('quantity')?.errors?.['min']">Min: 1</div>
                        </div>
                      </td>
                      <td class="text-left product-delete">
                        <button 
                          type="button" 
                          class="btn btn-outline-danger btn-sm"
                          (click)="removeProduct(i)"
                          title="Remove product"
                        >
                          <i class="mdi mdi-delete"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Add Product Button -->
              <div class="mt-2">
                <button 
                  type="button" 
                  class="btn btn-outline-primary btn-sm"
                  (click)="addProduct()"
                >
                  <i class="mdi mdi-plus"></i> Add Product
                </button>
              </div>
              
              <!-- Loading State -->
              <div *ngIf="loadingProducts" class="alert alert-info" role="status">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Loading products...
              </div>
            </div>

            <!-- Direct Items Section -->
            <div class="form-group mb-4 file-upload-block">
              <label class="mb-2 d-flex align-items-center justify-content-between">
                <span>Direct Items <span class="text-muted">(optional)</span></span>
                <button type="button" class=" btn-link p-0" (click)="onOpenCreateItemModal()">+ Create new item</button>
              </label>
              
              <!-- Category Filter Card -->
              <div class="card mb-3">
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <label for="directItemsCategoryFilter" class="form-label">Filter by Category</label>
                      <ng-select
                        id="directItemsCategoryFilter"
                        class="w-100"
                        [items]="categoryOptionsList"
                        bindLabel="categoryName"
                        bindValue="_id"
                        placeholder="All Categories"
                        [(ngModel)]="selectedDirectItemsCategoryId"
                        [ngModelOptions]="{standalone: true}"
                        (change)="onDirectItemsCategoryChange()"
                        [searchable]="true"
                        [clearable]="true"
                        [disabled]="categoryOptionsList.length === 0 || loadingCategories">
                      </ng-select>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Direct Items Table -->
              <div formArrayName="directItems" class="table-responsive add-product-item-add mt-2">
                <table class="table table-bordered table-hover">
                  <thead class="table-light">
                    <tr>
                      <th width="50%">Item</th>
                      <th width="25%"></th>
                      <th width="15%">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr 
                      *ngFor="let item of directItems.controls; let i = index" 
                      [formGroupName]="i"
                    >
                      <td>
                        <ng-multiselect-dropdown
                          *ngIf="itemDropdownSettings"
                          [placeholder]="'Select an item'"
                          [settings]="itemDropdownSettings"
                          [data]="getAvailableDirectItemsForIndex(i)"
                          formControlName="selectedItem"
                          (onSelect)="onDirectItemSelect($event, i)"
                          (onDeSelect)="onDirectItemDeSelect($event, i)"
                          class="form-control"
                          [ngClass]="{'is-invalid': item.get('itemId')?.invalid && item.get('itemId')?.touched}"
                        >
                        </ng-multiselect-dropdown>
                        <div 
                          *ngIf="item.get('itemId')?.invalid && item.get('itemId')?.touched" 
                          class="invalid-feedback d-block"
                        >
                          <div *ngIf="item.get('itemId')?.errors?.['duplicate']">This item is already selected</div>
                        </div>
                      </td>
                      <td>
                        <app-mat-input label="Quantity" 
                          type="number" 
                          formControlName="quantity" 
                          class="form-control"
                          min="1"
                          [class.is-invalid]="item.get('quantity')?.invalid && item.get('quantity')?.touched">
                        </app-mat-input>
                        <div 
                          *ngIf="item.get('quantity')?.invalid && item.get('quantity')?.touched" 
                          class="invalid-feedback d-block"
                        >
                          <div *ngIf="item.get('quantity')?.errors?.['required']">Required</div>
                          <div *ngIf="item.get('quantity')?.errors?.['min']">Min: 1</div>
                        </div>
                      </td>
                      <td class="text-left product-delete">
                        <button 
                          type="button" 
                          class="btn btn-outline-danger btn-sm"
                          (click)="removeDirectItem(i)"
                          title="Remove direct item"
                        >
                          <i class="mdi mdi-delete"></i>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Add Direct Item Button -->
              <div class="mt-2">
                <button 
                  type="button" 
                  class="btn btn-outline-primary btn-sm"
                  (click)="addDirectItem()"
                >
                  <i class="mdi mdi-plus"></i> Add Direct Item
                </button>
              </div>
              
              <!-- Loading State -->
              <div *ngIf="loadingItems" class="alert alert-info" role="status">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Loading items...
              </div>
            </div>

            <app-create-item-modal 
              [isVisible]="showCreateItemModal" 
              (closed)="onCloseCreateItemModal()"
              (created)="onItemCreatedFromModal($event)">
            </app-create-item-modal>

    </div>

          </div>



            <div class="d-flex justify-content-end">
              <a routerLink="/projects" class="btn btn-primary secondary-line-btn-cancel">Cancel</a>
              <button type="submit" class="btn btn-primary ms-2" [disabled]="submitting || form.invalid">Create</button>
            </div>
          </form>
        
        


        </div>
      </section>
    </div>
  </main>
</div>


