<div class="content-wrapper pb-0" *ngIf="item; else loadingTpl">
  <div class="page-header flex-wrap">
    <h3 class="mb-0">
      View Item <br>
      <span class="pl-0 h6 text-sub d-inline-block">Item in the inventory</span>
    </h3>
    <div class="d-flex">
      <ul class="breadcrumb">
        <li><a routerLink="/dashboard">Dashboard</a></li>
        <li><a routerLink="/items">Item management</a></li>
        <li>View item</li>
      </ul>
    </div>
  </div>
  

  <section class="card">
    <div class="card-body">
      <div class="row">
        <div class="col-lg-5">
          <img
            [src]="item.itemImage || '/assets/images/no-image-placeholder.svg'"
            alt="Item image"
            class="item-image"
          />
        </div>
        <div class="col-lg-7">
          <div class="mb-3"><strong>Description:</strong><br />{{ item.itemDescription || '—' }}</div>
          <div class="mb-2"><strong>Supplier:</strong> {{ getSupplierName(item) }}</div>
          <div class="mb-2"><strong>Unit Scale:</strong> {{ item.unitScale }}</div>
          <div class="mb-2"><strong>Available Qty:</strong> {{ item.availableQty }}</div>
          <div class="mb-2" *ngIf="!isUser2">
            <strong>Selling Cost:</strong>
            <span *ngIf="item.sellingCost !== undefined">AED {{ item.sellingCost }}</span>
            <span *ngIf="item.sellingCost === undefined">—</span>
          </div>
        </div>
      </div>
    </div>
  </section>
  
  <section class="card mt-4" *ngIf="isSuperAdmin && !isUser2">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Stock History</h5>
        <div *ngIf="stockMeta" class="text-muted small">
          Page {{ stockMeta.page }} of {{ stockMeta.totalPages }} · {{ stockMeta.total }} records
        </div>
      </div>

      <div *ngIf="loadingHistory" class="text-center py-4">
        <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
        <p class="mt-2 text-muted mb-0">Loading stock history...</p>
      </div>

      <div *ngIf="!loadingHistory && stockHistory.length === 0" class="text-center py-4 text-muted">
        No stock history available.
      </div>

      <div class="table-responsive" *ngIf="!loadingHistory && stockHistory.length > 0">
        <table class="table table-striped table-common">
          <thead>
            <tr>
              <th>Date</th>
              <th>Change</th>
              <th>Reason</th>
              <th>Unit Cost (AED)</th>
              <th>Selling Cost (AED)</th>
              <th>Previous Qty</th>
              <th>New Qty</th>
              <th>Created By</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let h of stockHistory">
              <td>{{ h.createdAt | date:'medium' }}</td>
              <td [ngClass]="{ 'text-success': h.change > 0, 'text-danger': h.change < 0 }">
                {{ h.change > 0 ? '+' : '' }}{{ h.change }}
              </td>
              <td>{{ h.reason || '—' }}</td>
              <td>{{ h.unitCost | number:'1.2-2' }}</td>
              <td>{{ h.sellingCost != null ? (h.sellingCost | number:'1.2-2') : '—' }}</td>
              <td>{{ h.previousAvailableQty }}</td>
              <td>{{ h.newAvailableQty }}</td>
              <td>{{ h.createdBy.name || h.createdBy.email || '—' }}</td>
              <td>
                <div class="table-actions">
                  <button class="mdl-button mdl-js-button mdl-button--icon mdl-button--colored"
                    (click)="openUpdateModal(h)" title="Edit item" aria-label="Edit item">
                    <i class="mdi mdi-pencil"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="pagination-block" *ngIf="stockMeta && stockMeta.totalPages > 0">
          <span class="pagecount">{{ ((stockMeta.page - 1) * stockMeta.limit) + 1 }}-{{ Math.min(stockMeta.page * stockMeta.limit, stockMeta.total) }} of {{ stockMeta.total }} records</span>
          <ul class="pagination">
            <li [class.disabled]="stockMeta.page === 1">
              <a href="#" (click)="loadStockHistory(stockMeta.page - 1); $event.preventDefault()" [class.disabled]="stockMeta.page === 1">&laquo;</a>
            </li>
            <li *ngFor="let p of [].constructor(stockMeta.totalPages); let i = index" [class.active]="(i+1) === stockMeta.page">
              <a href="#" (click)="loadStockHistory(i+1); $event.preventDefault()" [class.active]="(i+1) === stockMeta.page">{{ i + 1 }}</a>
            </li>
            <li [class.disabled]="stockMeta.page === stockMeta.totalPages">
              <a href="#" (click)="loadStockHistory(stockMeta.page + 1); $event.preventDefault()" [class.disabled]="stockMeta.page === stockMeta.totalPages">&raquo;</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Update Selling Cost Modal -->
<app-update-selling-cost-modal
  [stockHistoryItem]="selectedStockItem"
  [isVisible]="showUpdateModal"
  (close)="closeUpdateModal()"
  (updated)="onSellingCostUpdated($event)"
></app-update-selling-cost-modal>

<ng-template #loadingTpl>
  <div class="text-center py-5">
    <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
    <p class="mt-3 text-muted mb-0">Loading item...</p>
  </div>
</ng-template>

